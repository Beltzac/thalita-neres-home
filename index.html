<!DOCTYPE html>
<html lang="en">

<head>
    <script>
        const baseUrl = ""
        const baseImageFilename = "https://static.wixstatic.com/media/c1926f_8e6efa1fa9d14176af07cd73ec97ac5c~mv2.png"; // Base image

        const overlayImages =
            [
                {
                    "nomeImagem": "Portfólio de Arquitetura",
                    "arquivo": "https://static.wixstatic.com/media/c1926f_c7fbeefb9a8740518c8d888fd8624771~mv2.png",
                    "urlLink": "/portfolio-arquitetura"
                },
                {
                    "nomeImagem": "Fotografias",
                    "arquivo": "https://static.wixstatic.com/media/c1926f_68000578d47140e4b1812f5b17b11afc~mv2.png",
                    "urlLink": "/fotografia"
                },
                {
                    "nomeImagem": "Ilustrações",
                    "arquivo": "https://static.wixstatic.com/media/c1926f_81d02541dfb34f6ba30a004f8df72cb7~mv2.png",
                    "urlLink": "/ilustracao"
                },
                {
                    "nomeImagem": "Exposições",
                    "arquivo": "https://static.wixstatic.com/media/c1926f_91b1bca2e29e44a79253c83382add706~mv2.png",
                    "urlLink": "/nenhuma-linha-e-inocente"
                },
                {
                    "nomeImagem": "Podcast",
                    "arquivo": "https://static.wixstatic.com/media/c1926f_1da1efe6ea8744b986bac8d595ae7144~mv2.png",
                    "urlLink": "/espera"
                },
                {
                    "nomeImagem": "Meus Livros",
                    "arquivo": "https://static.wixstatic.com/media/c1926f_64c0f9a6ef9141a09b1ff35df079cf38~mv2.png",
                    "urlLink": "/meuslivros"
                },
                {
                    "nomeImagem": "Sobre",
                    "arquivo": "https://static.wixstatic.com/media/c1926f_4013caefa05a461b9f9a8397f6c0d24f~mv2.png",
                    "urlLink": "/sobremim"
                },
                {
                    "nomeImagem": "Vídeo",
                    "arquivo": "https://static.wixstatic.com/media/c1926f_61cb5cedd5d9464faa83a4cb8e73ad8d~mv2.png",
                    "urlLink": "/espera"
                }
            ]


        document.addEventListener("DOMContentLoaded", function () {

            console.log(overlayImages.length + " imagens");

            let lastClosestImageIndex = -1; // To keep track of the closest image

            const imageContainer = document.getElementById('imageContainer');

            let preProcessedOverlays = [];

            // Function to create an image and append it to the container
            function createAndAppendImage(src, zIndex, visible) {
                const img = document.createElement('img');
                img.crossOrigin = "anonymous";
                img.src = src;
                img.classList.add('imageLayer');
                img.style.zIndex = zIndex;
                img.style.display = visible ? '' : 'none';
                imageContainer.appendChild(img);
                return img; // Return the image element for further use if necessary
            }

            // Create images
            const baseImage = createAndAppendImage(baseUrl + baseImageFilename, 1, true);
            let overlayElements = overlayImages.map((overlay, index) =>
                createAndAppendImage(baseUrl + overlay.arquivo, index + 2, false)
            );

            var loadedImages = 0;
            var totalImages = overlayElements.length + 1; // +1 for base image

            baseImage.onload = () => {
                const baseCenter = preProcessOverlays(baseImage);
                centerMenu(baseCenter);
                loadedImages++;
                checkAllLoaded();
            };

            overlayElements.forEach((img, index) => {
                img.onload = () => {
                    preProcessedOverlays[index] = preProcessOverlays(img);
                    loadedImages++;
                    checkAllLoaded();
                };
            });

            function checkAllLoaded() {
                if (loadedImages === totalImages) {
                    setupImagesEvents();
                    document.querySelector('.lds-facebook').style.display = 'none';
                }
            }

            function centerMenu(baseCenter) {
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                // Calculate the offset to center the base image's center of mass
                // We want baseCenter.centerX to be at viewportWidth / 2
                // and baseCenter.centerY to be at viewportHeight / 2

                // The image is currently at (0,0) relative to the container
                // We need to move the container so that (baseCenter.centerX, baseCenter.centerY) is at (viewportWidth/2, viewportHeight/2)

                // However, the image is scaled to fit the height of the window (CSS height: 100%)
                // We need to account for this scaling.

                const scale = viewportHeight / baseCenter.height;

                const scaledCenterX = baseCenter.centerX * scale;
                const scaledCenterY = baseCenter.centerY * scale;

                const offsetX = (viewportWidth / 2) - scaledCenterX;
                const offsetY = (viewportHeight / 2) - scaledCenterY;

                imageContainer.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
            }

            function setupImagesEvents() {
                imageContainer.addEventListener('mousemove', function (e) {
                    findClosestImage(overlayElements, e.offsetX, e.offsetY);
                });

                imageContainer.addEventListener('mousemove', function (e) {
                    var imageName = overlayImages[lastClosestImageIndex]?.nomeImagem;
                    changeCursor(imageName);
                    showName(imageName, e.offsetX, e.offsetY);
                });

                imageContainer.addEventListener('click', function (e) {
                    if (lastClosestImageIndex >= 0) {
                        var overlay = overlayImages[lastClosestImageIndex];

                        confettiExplosion(e.clientX, e.clientY);

                        setTimeout(async () => {
                       		window.parent.postMessage(overlay.urlLink, "*");
                        	console.log('Url enviada:' + overlay.urlLink);
                		}, 1000);


                    }
                });
            }

            // Pre-process overlays to find center of mass
            function preProcessOverlays(overlay) {
                const offScreenCanvas = document.createElement('canvas');
                const ctx = offScreenCanvas.getContext('2d');

                offScreenCanvas.width = overlay.naturalWidth;
                offScreenCanvas.height = overlay.naturalHeight;

                ctx.drawImage(overlay, 0, 0);

                const imageData = ctx.getImageData(0, 0, offScreenCanvas.width, offScreenCanvas.height);
                const data = imageData.data;
                let totalX = 0;
                let totalY = 0;
                let count = 0;

                for (let y = 0; y < offScreenCanvas.height; y += 5) { // Optimization: skip pixels
                    for (let x = 0; x < offScreenCanvas.width; x += 5) {
                        const alpha = data[(y * offScreenCanvas.width + x) * 4 + 3];
                        if (alpha > 0) {
                            totalX += x;
                            totalY += y;
                            count++;
                        }
                    }
                }

                const centerX = count > 0 ? totalX / count : offScreenCanvas.width / 2;
                const centerY = count > 0 ? totalY / count : offScreenCanvas.height / 2;

                return { centerX, centerY, width: offScreenCanvas.width, height: offScreenCanvas.height };
            }

            // Function to find the closest image based on center of mass
            function findClosestImage(overlayElements, x, y) {
                lastClosestImageIndex = -1;
                let minDistance = Infinity;

                // We need to adjust x and y because the container is now transformed
                // x and y are relative to the viewport (e.offsetX/Y on the container might be affected by transform depending on browser,
                // but since we attached listener to imageContainer, offsetX/Y are relative to the target node padding edge)

                // Actually, since we are using offsetX/Y on the container, and the container is transformed,
                // the coordinates should be relative to the container's top-left, which is what we want.
                // However, we need to be careful about the scaling.

                const boundingBox = baseImage.getBoundingClientRect();
                // Assuming all images have the same aspect ratio and size as the base image
                // Use the first overlay or base image for scale reference if overlays are empty (unlikely)
                const refWidth = preProcessedOverlays[0] ? preProcessedOverlays[0].width : baseImage.naturalWidth;
                const refHeight = preProcessedOverlays[0] ? preProcessedOverlays[0].height : baseImage.naturalHeight;

                const scaleX = refWidth / boundingBox.width;
                const scaleY = refHeight / boundingBox.height;

                const scaledX = x * scaleX;
                const scaledY = y * scaleY;

                for (let i = 0; i < overlayElements.length; i++) {
                    const preProcessed = preProcessedOverlays[i];
                    const dx = scaledX - preProcessed.centerX;
                    const dy = scaledY - preProcessed.centerY;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < minDistance) {
                        minDistance = distance;
                        lastClosestImageIndex = i;
                    }

                    // Hide all initially
                    overlayElements[i].style.display = 'none';
                }

                // Show only the closest one
                if (lastClosestImageIndex >= 0) {
                    overlayElements[lastClosestImageIndex].style.display = '';
                }
            }

            function showToast(message) {
                const toastContainer = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.classList.add('toast');
                toast.textContent = message;

                // Add the toast to the container
                toastContainer.appendChild(toast);

                // Show the toast
                setTimeout(() => {
                    toast.style.opacity = 1;
                }, 100);

                // Hide and remove the toast after 3 seconds
                setTimeout(() => {
                    toast.style.opacity = 0;
                    setTimeout(() => toastContainer.removeChild(toast), 500); // Ensure fade out completes
                }, 3000);
            }

            function showName(name, x, y) {
                const nameContainer = document.getElementById('objectDescription');

                if (!name) {
                    nameContainer.style.display = 'none';
                    return;
                }

                // Set the text content
                nameContainer.textContent = name;

                // Position the container at the mouse coordinates with an offset
                // at the center bottom of the container
                // if it would be out of the screen put it at the bottom instead

                var halfDescriptionHeight = nameContainer.offsetHeight / 2;
                var halfDescriptionWidth = nameContainer.offsetWidth / 2;
                var verticalOffset = 50;
                var borderOffset = 10;

                // Get the current transform of the imageContainer
                const style = window.getComputedStyle(imageContainer);
                const matrix = new WebKitCSSMatrix(style.transform);
                const offsetX = matrix.m41;
                const offsetY = matrix.m42;

                // Adjust x and y by adding the offset
                const adjustedX = x + offsetX;
                const adjustedY = y + offsetY;

                nameContainer.style.left = adjustedX - halfDescriptionWidth + 'px';
                if (adjustedY - verticalOffset - halfDescriptionHeight - borderOffset < 0) {
                    nameContainer.style.top = adjustedY - halfDescriptionHeight + verticalOffset + 'px';
                } else {
                    nameContainer.style.top = adjustedY - halfDescriptionHeight - verticalOffset + 'px';
                }

                // Make the container visible
                nameContainer.style.display = 'block';
            }

            function changeCursor(enabled) {
                imageContainer.style.cursor = enabled ? 'pointer' : 'default';
            }
        });

        function confettiExplosion(x, y) {
            const numConfetti = 30;
            for (let i = 0; i < numConfetti; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = x + 'px';
                confetti.style.top = y + 'px';

                // Random size between 5px and 15px
                const size = Math.random() * 10 + 5;
                confetti.style.width = size + 'px';
                confetti.style.height = size + 'px';

                // Random explosion properties: angle and distance
                const angle = Math.random() * 2 * Math.PI;
                const distance = Math.random() * 250 + 50;
                const translateX = Math.cos(angle) * distance;
                const translateY = Math.sin(angle) * distance;
                confetti.style.setProperty('--translateX', translateX + 'px');
                confetti.style.setProperty('--translateY', translateY + 'px');

                // Random initial rotation
                const initialRotation = Math.random() * 360;
                confetti.style.transform = `rotate(${initialRotation}deg)`;

                // Random animation duration between 2.5s and 3.5s
                const duration = Math.random() * 1 + 2.5;
                confetti.style.animationDuration = duration + 's';

                // Slight random animation delay
                confetti.style.animationDelay = Math.random() * 0.2 + 's';

                // Improved color using HSL with softer saturation/lightness
                confetti.style.backgroundColor = `hsl(${Math.floor(Math.random() * 360)}, 80%, 60%)`;

                document.body.appendChild(confetti);

                // Remove the confetti element after the animation ends
                setTimeout(() => confetti.remove(), duration * 1000);
            }
        }
    </script>
    <style>
        @font-face {
            font-family: 'Thata';
            src: url('https://static.wixstatic.com/ufonts/c1926f_163cafe5c04d48cbbb27552644b8fe60/file.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        #imageContainer {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }

        .imageLayer,
        canvas {
            position: absolute;
            height: 100%;
            width: auto; /* Maintain aspect ratio */
        }

        #toastContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
        }

        .toast {
            background-color: #333;
            color: white;
            padding: 16px;
            margin-bottom: 20px;
            opacity: 0;
            transition: opacity 0.5s;
        }

        #objectDescription {
            pointer-events: none;
            position: absolute;
            display: none;
            z-index: 1000;
            background-color: rgb(243, 243, 243);
            padding: 8px;
            border-radius: 4px;
            font-size: 5vh;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            font-family: 'Thata', sans-serif;
        }

        #instructionText {
            position: fixed;
            top: 4vh;
            left: 0;
            width: 100%;
            z-index: 2000;
            font-family: 'Thata', sans-serif;
            font-size:5vh;
            color: #000;
            text-align: center;
            pointer-events: none;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        /* Loader */
        .lds-facebook {
            display: inline-block;
            position: absolute;
            width: 80px;
            height: 80px;
            z-index: 100000;
            top: calc(50% - 40px);
            left: calc(50% - 40px);
        }

        .lds-facebook div {
            display: inline-block;
            position: absolute;
            left: 8px;
            width: 16px;
            background: #000000;
            animation: lds-facebook 1.2s cubic-bezier(0, 0.5, 0.5, 1) infinite;
        }

        .lds-facebook div:nth-child(1) {
            left: 8px;
            animation-delay: -0.24s;
        }

        .lds-facebook div:nth-child(2) {
            left: 32px;
            animation-delay: -0.12s;
        }

        .lds-facebook div:nth-child(3) {
            left: 56px;
            animation-delay: 0;
        }

        @keyframes lds-facebook {
            0% {
                top: 8px;
                height: 64px;
            }

            50%,
            100% {
                top: 24px;
                height: 32px;
            }
        }

        .confetti {
            position: fixed;
            pointer-events: none;
            z-index: 10000;
            opacity: 1;
            /* Use clip-path to create a star shape */
            clip-path: polygon(50% 0%,
                    61% 35%,
                    98% 35%,
                    68% 57%,
                    79% 91%,
                    50% 70%,
                    21% 91%,
                    32% 57%,
                    2% 35%,
                    39% 35%);
            animation-name: confettiFall;
            animation-timing-function: ease-out;
            animation-fill-mode: forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translate(0, 0) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translate(var(--translateX), var(--translateY)) rotate(720deg);
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div class="lds-facebook">
        <div></div>
        <div></div>
        <div></div>
    </div>
    <div id="objectDescription"></div>
    <div id="toastContainer"></div>
    <div id="instructionText">Para acessar os portfólios, recomendações e outros recursos, clique em qualquer item da ilustração.</div>
    <div id="imageContainer"></div>
</body>

</html>